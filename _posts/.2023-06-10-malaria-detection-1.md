---
layout: post
title: "Malaria Detection (Part 1: Introduction and Data Prep)"
date: 2023-06-10
categories: [Machine Learning]
tags: [study-notes, machine-learning, data-science, cnn, deep-learning]
---

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>


## Table of Contents
1. [Introduction](#introduction)
2. [Problem Definition](#problem-definition)
3. [Data Description](#data-description)
4. [Setting Up the Environment](#setting-up-the-environment)



## Introduction
I have recently learned more formally about convolutional neural networks (CNNs) and how it is applied to analyze images. Now that I think I have the basics under my belt, I decided to dive into a real-world problem in healthcare, an area that I care much about. I found the Malaria dataset on [Kaggle](https://www.kaggle.com/datasets/iarunava/cell-images-for-detecting-malaria), and decided to give it a try.

Malaria is a life-threatening disease caused by parasites that enter the bloodstream and damage red blood cells (RBCs). Early detection and treatment are crucial to prevent complications, death, and the spread of the disease within communities. Traditional medical examinations for malaria detection are time-consuming and require trained professionals, whose accuracy depends heavily on their training and experience.

In this series of blog posts, we'll explore how to develop an automated system to detect malaria from images of a patient's RBCs using deep learning techniques. Our goal is to create a highly accurate and efficient system that can distinguish between parasitized and uninfected RBCs in microscopic images.


## Problem Definition

Our task is to develop a supervised learning algorithm using a convolutional neural network (CNN) trained on a large labeled dataset of RBC images. The dataset contains both parasitized and uninfected cells. Given the potentially fatal nature of malaria, we need to ensure a high recall rate to detect as many cases as possible.

## Data Description

The dataset contains equal number of parasitized and uninfected cells images. I separate them first into a train dataset consists of 24,958 images and 2,600 test images, both equally split between parasitized and uninfected as we will double check later. These are colored microscopic images of RBCs, categorized as follows:

- **Parasitized**: Cells containing the Plasmodium parasite, which causes malaria
- **Uninfected**: Cells free of the Plasmodium parasites

We'll define a function to load our image data and preprocess it for our neural network:

```python
def load_data(data_path):
  X, y = [], []
  for label, category in zip([1, 0], ['parasitized', 'uninfected']):
    path = os.path.join(data_path, category)
    for img in tqdm(os.listdir(path)):
      img_path = os.path.join(path, img)
      img_array = cv2.imread(img_path)
      new_image = cv2.resize(img_array, (64, 64))
      X.append(np.array(new_image))
      y.append(label)
  return X, y

X_train, y_train = load_data(TRAINING_DATAPATH)
X_test, y_test = load_data(TESTING_DATAPATH)
```

This function reads the images, resizes them to 64x64 pixels, and assigns labels (1 for parasitized, 0 for uninfected).

## Data Exploration and Visualization

Let's explore our dataset to gain some insights:

```python
print(f"The shape of the train data is {X_train_np.shape}, and the shape of the test data is {X_test_np.shape}")
print(f"The size of the train labels is {y_train_np.shape}, and the size of the test labels is {y_test_np.shape}")
```

We can see that our training set contains 24,981 images, while our test set has 2,600 images. Each image is 64x64 pixels with 3 color channels (RGB).

Let's visualize some of our images from both the parasitized and uninfected cells. The key difference between parasitized and uninfected RBCs is the presence of purple spots or circles on the parasitized RBCs.

```python
fig = plt.figure(figsize=(12, 12))
for i in range(36):
  ax = fig.add_subplot(6, 6, i+1)
  sample_num = parasitized_idx[i] if i < 18 else uninfected_idx[i-18]
  ax.imshow(X_train_rgb_normalized[sample_num])
  ax.title.set_text(f"Label: {y_train_np[sample_num]}")
  plt.axis('off')
plt.tight_layout()
plt.show()
```

![Figure 1. Samples of Parasitized and Uninfected RBCs](/assets/img/post_assets/malaria-detection/cell_images_sample.png)


Given that the presence of purple spots seems to differentiate the parasitised from the uninfected, this informaiton must also show up in the images' color informaiton. An RGB image has three channels, so let's plot the histogram of each channel


```python
fig, axes = plt.subplots(1, 3, figsize=(10, 3))
# plot the histogram of each channel
axes[0].hist(X_train_np[:, :, :, 0].ravel(), bins=15)
axes[0].set_title('Red')
axes[1].hist(X_train_np[:, :, :, 1].ravel(), bins=15)
axes[1].set_title('Green')
axes[2].hist(X_train_np[:, :, :, 2].ravel(), bins=15)
axes[2].set_title('Blue')
plt.tight_layout()
plt.show()
```

I am testing Grammarly

    
![png](Reference_Notebook_Malaria_Detection_Full_Code_files/Reference_Notebook_Malaria_Detection_Full_Code_24_0.png)
    


## Data Preprocessing

To prepare our data for the neural network, we'll perform the following steps:

1. Normalize the pixel values to be between 0 and 1
2. Convert the images from RGB to HSV color space
3. Apply Gaussian blurring to reduce noise

```python
X_train_rgb_normalized = (X_train_np / 255.0).astype('float32')
X_test_rgb_normalized = (X_test_np / 255.0).astype('float32')

X_train_hsv = [cv2.cvtColor(image, cv2.COLOR_RGB2HSV).astype('float32') for image in X_train_rgb_normalized]
X_test_hsv = [cv2.cvtColor(image, cv2.COLOR_RGB2HSV).astype('float32') for image in X_test_rgb_normalized]

def gaussian_blur(images, kernel_size=(3, 3), sigma=0, border_type=cv2.BORDER_DEFAULT, hsv_ranges = np.array([360, 1, 1])):
  blurred_images = [cv2.GaussianBlur(image, kernel_size, sigma, border_type) for image in images]
  blurred_images_np = np.stack(blurred_images, axis=0)
  blurred_images_normalized = blurred_images_np / hsv_ranges
  return blurred_images_normalized

X_train_blur_normalized = gaussian_blur(X_train_hsv)
X_test_blur_normalized = gaussian_blur(X_test_hsv)
```

These preprocessing steps help to enhance the features that distinguish parasitized from uninfected cells and reduce noise in the images.

In the next part of this series, we'll dive into building and training our deep learning models for malaria detection. Stay tuned!